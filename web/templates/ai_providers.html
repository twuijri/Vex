{% extends "base.html" %}
{% block title %}Vex â€” Ù…Ø²ÙˆØ¯Ùˆ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ{% endblock %}
{% block page_title %}ğŸ¤– Ø§Ù„Ù…Ø²ÙˆØ¯ÙˆÙ†{% endblock %}

{% block head %}
<script>
    const PRESETS = {
        google_studio: [
            { label: "Gemini 2.0 Flash â€” Ù…Ø¬Ø§Ù†ÙŠ Â· Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹", value: "gemini-2.0-flash" },
            { label: "Gemini 2.0 Flash Lite â€” Ø£Ø®Ù", value: "gemini-2.0-flash-lite" },
            { label: "Gemini 1.5 Flash", value: "gemini-1.5-flash" },
            { label: "Gemini 1.5 Pro", value: "gemini-1.5-pro" },
        ],
        huggingface: [
            { label: "AraBART (Ù†Ù…ÙˆØ°Ø¬ Ø¹Ø±Ø¨ÙŠ)", value: "moussaKam/AraBART" },
            { label: "AraBERT v02", value: "aubmindlab/bert-base-arabertv02" },
            { label: "CAMeL BERT", value: "CAMeL-Lab/bert-base-arabic-camelbert-mix" },
        ],
        blackbox: [{ label: "(Ø¬Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ)", value: "" }],
    };

    function onTypeChange() {
        const type = document.getElementById("provider_type").value;
        if (type === "blackbox") {
            document.getElementById("api_key_input").placeholder = "Ø¶Ø¹ cookies/session Ø£Ùˆ API key";
        } else {
            document.getElementById("api_key_input").placeholder = "Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ù€ API";
        }
        populatePresets(type);
    }

    function populatePresets(type) {
        const sel = document.getElementById("model_preset");
        sel.innerHTML = "";
        (PRESETS[type] || []).forEach(p => {
            const o = document.createElement("option");
            o.value = p.value; o.textContent = p.label; sel.appendChild(o);
        });
        if (sel.options.length > 0) document.getElementById("model").value = sel.options[0].value;
    }

    function onPresetChange() {
        const val = document.getElementById("model_preset").value;
        if (val) document.getElementById("model").value = val;
    }

    async function fetchModels() {
        const type = document.getElementById("provider_type").value;
        const key = document.getElementById("api_key_input").value;
        if (!key) { alert("Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ API Ø£ÙˆÙ„Ø§Ù‹"); return; }
        const btn = document.getElementById("btn_fetch");
        btn.disabled = true; btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...";
        try {
            const r = await fetch(`/dashboard/ai-providers/fetch-models?provider_type=${type}&api_key=${encodeURIComponent(key)}`);
            const d = await r.json();
            if (d.models && d.models.length) {
                const sel = document.getElementById("model_preset");
                sel.innerHTML = "";
                d.models.forEach(m => {
                    const o = document.createElement("option");
                    o.value = m; o.textContent = m; sel.appendChild(o);
                });
                document.getElementById("model").value = d.models[0];
            } else {
                alert(d.error || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¯ÙŠÙ„Ø§Øª");
            }
        } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
        btn.disabled = false; btn.textContent = "ğŸ” Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª";
    }

    window.onload = () => populatePresets(document.getElementById("provider_type").value);
</script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Ù…Ø²ÙˆØ¯Ùˆ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h1>
    <p class="page-subtitle">ÙŠÙØ¬Ø±ÙÙ‘Ø¨ Ø§Ù„Ù…Ø²ÙˆØ¯ÙˆÙ† Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ â€” Ø¥Ø°Ø§ ÙØ´Ù„ Ø£Ø­Ø¯Ù‡Ù… Ø§Ù†ØªÙ‚Ù„ Ù„Ù„ØªØ§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
</div>

{% if providers %}
<div style="display:flex;flex-direction:column;gap:0.6rem;margin-bottom:1.5rem;">
    {% for p in providers %}
    {% set icons = {"google_studio": "ğŸ”µ", "blackbox": "ğŸŸ£", "huggingface": "ğŸŸ "} %}
    <div class="card card-sm {% if not p.is_active %}inactive{% endif %}"
        style="display:flex;align-items:center;gap:0.75rem;opacity:{% if p.is_active %}1{% else %}.55{% endif %};">
        <!-- Order + Icon -->
        <div style="display:flex;align-items:center;gap:0.5rem;flex-shrink:0;">
            <div class="provider-order">{{ loop.index }}</div>
            <div style="font-size:1.4rem;">{{ icons.get(p.provider_type, "ğŸ¤–") }}</div>
        </div>
        <!-- Info -->
        <div style="flex:1;min-width:0;">
            <div style="font-weight:700;color:var(--primary);font-size:0.92rem;">{{ p.name }}</div>
            <div
                style="font-size:0.73rem;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                {{ p.provider_type }} Â· {{ p.model[:35] }}{% if p.model|length > 35 %}â€¦{% endif %}
            </div>
        </div>
        <!-- Actions -->
        <div style="display:flex;gap:0.3rem;flex-shrink:0;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
            {% if not loop.first %}
            <form method="post" action="/dashboard/ai-providers/{{ p.id }}/move">
                <input type="hidden" name="direction" value="up">
                <button type="submit" class="btn btn-ghost btn-sm">â¬†ï¸</button>
            </form>
            {% endif %}
            {% if not loop.last %}
            <form method="post" action="/dashboard/ai-providers/{{ p.id }}/move">
                <input type="hidden" name="direction" value="down">
                <button type="submit" class="btn btn-ghost btn-sm">â¬‡ï¸</button>
            </form>
            {% endif %}
            <form method="post" action="/dashboard/ai-providers/{{ p.id }}/toggle">
                <button type="submit" class="btn btn-sm {% if p.is_active %}btn-success{% else %}btn-danger{% endif %}">
                    {% if p.is_active %}âœ…{% else %}â›”{% endif %}
                </button>
            </form>
            <form method="post" action="/dashboard/ai-providers/{{ p.id }}/delete"
                onsubmit="return confirm('Ø­Ø°Ù {{ p.name }}ØŸ')">
                <button type="submit" class="btn btn-danger btn-sm">ğŸ—‘ï¸</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card" style="margin-bottom:1.5rem;">
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ¤–</div>
        <div class="empty-state-text">Ù„Ù… ØªÙØ¶Ù Ø£ÙŠ Ù…Ø²ÙˆØ¯ÙŠÙ† â€” Ø£Ø¶Ù Ø£ÙˆÙ„ Ù…Ø²ÙˆØ¯ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¯Ù†Ø§Ù‡</div>
    </div>
</div>
{% endif %}

<!-- Add form -->
<div class="card">
    <h2 style="font-size:1rem;font-weight:700;color:var(--primary);margin-bottom:1.25rem;">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø²ÙˆØ¯ Ø¬Ø¯ÙŠØ¯</h2>
    <form method="post" action="/dashboard/ai-providers/add">
        <div class="form-grid" style="margin-bottom:1rem;">
            <div class="form-group">
                <label class="form-label">Ø§Ù„Ø§Ø³Ù… (Ù„Ù„ØªØ¹Ø±ÙŠÙ ÙÙ‚Ø·)</label>
                <input class="input" type="text" name="name" placeholder="Ù…Ø«Ø§Ù„: Gemini Key 1" required>
            </div>
            <div class="form-group">
                <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø²ÙˆØ¯</label>
                <select class="select-field" name="provider_type" id="provider_type" onchange="onTypeChange()">
                    <option value="google_studio">ğŸ”µ Google AI Studio</option>
                    <option value="blackbox">ğŸŸ£ Blackbox.ai</option>
                    <option value="huggingface">ğŸŸ  HuggingFace</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Ù…ÙØªØ§Ø­ API</label>
                <input class="input" type="password" name="api_key" id="api_key_input" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ù€ API"
                    required>
            </div>
            <div class="form-group">
                <label class="form-label">Ø§Ù„ØªØ±ØªÙŠØ¨ (Ø£ØµØºØ± = ÙŠÙØ¬Ø±ÙÙ‘Ø¨ Ø£ÙˆÙ„Ø§Ù‹)</label>
                <input class="input" type="number" name="priority" value="10" min="1" max="999">
            </div>
            <div class="form-group" style="grid-column:1/-1;">
                <label class="form-label">Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</label>
                <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;align-items:center;flex-wrap:wrap;">
                    <select class="select-field" id="model_preset" onchange="onPresetChange()"
                        style="flex:1;min-width:150px;"></select>
                    <button type="button" id="btn_fetch" onclick="fetchModels()" class="btn btn-ghost btn-sm"
                        style="white-space:nowrap;">ğŸ” Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª</button>
                </div>
                <input class="input" type="text" name="model" id="model" placeholder="Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠØ¯ÙˆÙŠØ§Ù‹"
                    required>
            </div>
        </div>
        <button type="submit" class="btn btn-primary btn-full btn-lg">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙˆØ¯</button>
    </form>
</div>
{% endblock %}