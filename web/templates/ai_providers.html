{% extends "base.html" %}

{% block title %}Vex â€” Ø¥Ø¯Ø§Ø±Ø© Ù…Ø²ÙˆØ¯ÙŠ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ{% endblock %}

{% block head %}
<style>
    .provider-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .provider-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        transition: border-color 0.2s;
    }

    .provider-row:hover {
        border-color: var(--primary-color);
    }

    .provider-row.inactive {
        opacity: 0.5;
    }

    .provider-order {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--primary-color);
        min-width: 32px;
        text-align: center;
    }

    .provider-icon {
        font-size: 1.8rem;
    }

    .provider-info {
        flex: 1;
    }

    .provider-name {
        font-weight: 700;
        font-size: 1rem;
    }

    .provider-meta {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 0.15rem;
    }

    .provider-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-sm {
        border: none;
        border-radius: 8px;
        padding: 0.4rem 0.75rem;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.85rem;
        font-weight: 600;
        transition: opacity 0.2s;
    }

    .btn-sm:hover {
        opacity: 0.8;
    }

    .btn-move {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .btn-toggle {
        background: #16a34a22;
        color: #4ade80;
    }

    .btn-toggle.off {
        background: #dc262622;
        color: #f87171;
    }

    .btn-delete {
        background: #dc262622;
        color: #f87171;
    }

    /* Add form */
    .add-form-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }

    .form-group label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
    }

    .form-group input,
    .form-group select {
        background: var(--bg-hover);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: inherit;
        font-size: 0.9rem;
        padding: 0.6rem 0.85rem;
        outline: none;
        transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
        border-color: var(--primary-color);
    }

    .form-group input[type="password"] {
        direction: ltr;
    }

    .btn-add {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.65rem 1.5rem;
        cursor: pointer;
        font-family: inherit;
        font-size: 1rem;
        font-weight: 700;
        margin-top: 0.5rem;
        width: 100%;
        transition: opacity 0.2s;
    }

    .btn-add:hover {
        opacity: 0.9;
    }

    /* Model presets shown/hidden */
    .model-presets {
        grid-column: 1 / -1;
    }

    /* Priority hint */
    .priority-hint {
        font-size: 0.78rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    /* Icons by type */
    .icon-google_studio {
        color: #4285f4;
    }

    .icon-blackbox {
        color: #a78bfa;
    }

    .icon-huggingface {
        color: #fb923c;
    }

    .empty-list {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
        font-size: 1rem;
    }
</style>
<script>
    const MODEL_PRESETS = {
        google_studio: [
            // Ø§Ù„Ø£Ø±Ø®Øµ ÙˆØ§Ù„Ø£Ø³Ø±Ø¹
            { v: "gemini-2.0-flash", l: "Gemini 2.0 Flash       â€” Ù…Ø¬Ø§Ù†ÙŠ Â· Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹ âš¡" },
            { v: "gemini-2.0-flash-lite", l: "Gemini 2.0 Flash Lite  â€” Ù…Ø¬Ø§Ù†ÙŠ Â· Ø§Ù„Ø£Ø±Ø®Øµ ğŸ’š" },
            { v: "gemini-1.5-flash", l: "Gemini 1.5 Flash       â€” Ù…Ø¬Ø§Ù†ÙŠ Â· Ù…ÙˆØµÙ‰ Ø¨Ù‡ âœ…" },
            { v: "gemini-1.5-flash-8b", l: "Gemini 1.5 Flash-8B    â€” Ù…Ø¬Ø§Ù†ÙŠ Â· ØµØºÙŠØ± ÙˆØ³Ø±ÙŠØ¹" },
            // Ø£Ù‚ÙˆÙ‰ Ù„ÙƒÙ† Ø£Ø¨Ø·Ø£
            { v: "gemini-1.5-pro", l: "Gemini 1.5 Pro         â€” Ù…Ø¬Ø§Ù†ÙŠ Â· 50 Ø·Ù„Ø¨/ÙŠÙˆÙ…" },
            { v: "gemini-2.0-pro", l: "Gemini 2.0 Pro         â€” Ù…Ø¯ÙÙˆØ¹ Â· Ø§Ù„Ø£Ù‚ÙˆÙ‰ ğŸ’" },
        ],
        blackbox: [
            // Ø±Ø®ÙŠØµØ© Ø¬Ø¯Ø§Ù‹
            { v: "deepseek-v3", l: "DeepSeek V3            â€” $0.07/M Â· Ø§Ù„Ø£Ø±Ø®Øµ â­" },
            { v: "deepseek-r1", l: "DeepSeek R1            â€” $0.14/M Â· ØªÙÙƒÙŠØ± Ø¹Ù…ÙŠÙ‚" },
            { v: "meta-llama/Llama-3.3-70b", l: "Llama 3.3 70B          â€” $0.20/M Â· Ù…ÙØªÙˆØ­ Ø§Ù„Ù…ØµØ¯Ø±" },
            { v: "meta-llama/Llama-3.1-405b", l: "Llama 3.1 405B         â€” $0.30/M Â· Ø¶Ø®Ù…" },
            // Ù…ØªÙˆØ³Ø·Ø©
            { v: "claude-3-5-haiku-20241022", l: "Claude 3.5 Haiku       â€” $0.25/M Â· Ø³Ø±ÙŠØ¹ ğŸ”µ" },
            { v: "gemini-1.5-flash", l: "Gemini 1.5 Flash       â€” $0.30/M Â· Ù…ØªÙˆØ§Ø²Ù†" },
            { v: "gpt-4o-mini", l: "GPT-4o Mini            â€” $0.50/M Â· Ù…ØªÙˆØ§Ø²Ù†" },
            // ØºØ§Ù„ÙŠØ© (Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ù„Ù„Ø§Ø¹ØªØ¯Ø§Ù„)
            { v: "claude-3-5-sonnet-20241022", l: "Claude 3.5 Sonnet      â€” $3/M  Â· ØºØ§Ù„ÙŠ ğŸ”´" },
            { v: "gpt-4o", l: "GPT-4o                 â€” $5/M  Â· ØºØ§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹ ğŸ”´" },
        ],
        huggingface: [
            { v: "aubmindlab/bert-base-arabertv02", l: "AraBERT â€” Ø¹Ø±Ø¨ÙŠ Ù…ØªØ®ØµØµ 100% âœ…" },
            { v: "CAMeL-Lab/bert-base-arabic-camelbert-mix-sentiment", l: "CAMeL Sentiment â€” ØªØ­Ù„ÙŠÙ„ Ù…Ø´Ø§Ø¹Ø± Ø¹Ø±Ø¨ÙŠ" },
            { v: "facebook/bart-large-mnli", l: "BART MNLI â€” ØªØµÙ†ÙŠÙ Ø¹Ø§Ù…" },
            { v: "joeddav/xlm-roberta-large-xnli", l: "XLM-RoBERTa â€” Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù„ØºØ§Øª" },
        ],
    };

    function onTypeChange() {
        const type = document.getElementById('provider_type').value;
        const modelSelect = document.getElementById('model_preset');
        const modelInput = document.getElementById('model');

        modelSelect.innerHTML = '';
        const presets = MODEL_PRESETS[type] || [];
        presets.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.v; opt.textContent = p.l;
            modelSelect.appendChild(opt);
        });
        if (presets.length) modelInput.value = presets[0].v;

        document.getElementById('model_label').textContent =
            type === 'huggingface' ? 'Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (HuggingFace repo/model)' : 'Ø§Ù„Ù†Ù…ÙˆØ°Ø¬';
    }

    function onPresetChange() {
        const val = document.getElementById('model_preset').value;
        document.getElementById('model').value = val;
    }

    async function fetchModels() {
        const type = document.getElementById('provider_type').value;
        const key = document.getElementById('api_key_input').value.trim();
        if (!key) { alert('Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ù€ API Ø£ÙˆÙ„Ø§Ù‹'); return; }

        const btn = document.getElementById('btn_fetch_models');
        btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...';
        btn.disabled = true;

        try {
            const url = `/dashboard/ai-providers/fetch-models?provider_type=${encodeURIComponent(type)}&api_key=${encodeURIComponent(key)}`;
            const resp = await fetch(url);
            const data = await resp.json();

            if (data.error && !data.models.length) {
                alert('Ø®Ø·Ø£: ' + data.error);
                return;
            }
            const select = document.getElementById('model_preset');
            select.innerHTML = '';
            data.models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.textContent = m;
                select.appendChild(opt);
            });
            if (data.models.length) {
                document.getElementById('model').value = data.models[0];
                alert(`âœ… ØªÙ… Ø¬Ù„Ø¨ ${data.models.length} Ù…ÙˆØ¯ÙŠÙ„. Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.`);
            }
        } finally {
            btn.textContent = 'ğŸ” Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª';
            btn.disabled = false;
        }
    }

    window.onload = onTypeChange;
</script>
{% endblock %}

{% block nav %}
<nav class="navbar">
    <div class="nav-brand">
        <span class="nav-logo">ğŸ¤–</span>
        <span class="nav-title">Vex</span>
        <span class="nav-badge">@{{ bot_username }}</span>
    </div>
    <div class="nav-links">
        <a href="/dashboard/" class="nav-link">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        <a href="/dashboard/groups" class="nav-link">ğŸ‘¥ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</a>
        <a href="/dashboard/users" class="nav-link">ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</a>
        <a href="/dashboard/logs" class="nav-link">ğŸ“‘ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</a>
        <a href="/dashboard/ai-stats" class="nav-link">ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</a>
        <a href="/dashboard/ai-providers" class="nav-link active">ğŸ¤– Ù…Ø²ÙˆØ¯Ùˆ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</a>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="dashboard">
    <h1 class="page-title">ğŸ¤– Ù…Ø²ÙˆØ¯Ùˆ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h1>
    <p style="color:var(--text-secondary);margin-bottom:1.5rem;">
        ÙŠØªÙ… ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø£Ø³ÙÙ„. Ø¥Ø°Ø§ ÙØ´Ù„ Ø£Ùˆ Ø§Ø³ØªÙ†ÙØ° Ø£Ø­Ø¯Ù‡Ù… ÙŠÙˆÙ…ÙŠÙ‡ØŒ ÙŠÙ†ØªÙ‚Ù„ Ø§Ù„Ø¨ÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„ØªØ§Ù„ÙŠ.
    </p>

    <!-- Provider list -->
    <div class="provider-list">
        {% if not providers %}
        <div class="empty-list">ğŸŒ™ Ù„Ù… ØªÙØ¶Ù Ø£ÙŠ Ù…Ø²ÙˆØ¯ÙŠÙ† Ø¨Ø¹Ø¯. Ø£Ø¶Ù Ø£ÙˆÙ„ Ù…Ø²ÙˆØ¯ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¯Ù†Ø§Ù‡.</div>
        {% endif %}

        {% for p in providers %}
        {% set icons = {"google_studio": "ğŸ”µ", "blackbox": "ğŸŸ£", "huggingface": "ğŸŸ "} %}
        <div class="provider-row {% if not p.is_active %}inactive{% endif %}">
            <div class="provider-order">{{ loop.index }}</div>
            <div class="provider-icon">{{ icons.get(p.provider_type, "ğŸ¤–") }}</div>
            <div class="provider-info">
                <div class="provider-name">{{ p.name }}</div>
                <div class="provider-meta">
                    {{ p.provider_type }} Â· {{ p.model }}
                    Â· Ø§Ù„Ù…ÙØªØ§Ø­: <code>{{ p.api_key[:8] }}â€¢â€¢â€¢â€¢</code>
                </div>
            </div>
            <div class="provider-actions">
                <!-- Move up -->
                {% if not loop.first %}
                <form method="post" action="/dashboard/ai-providers/{{ p.id }}/move">
                    <input type="hidden" name="direction" value="up">
                    <button class="btn-sm btn-move" title="ØªØ­Ø±ÙŠÙƒ Ù„Ù„Ø£Ø¹Ù„Ù‰">â¬†ï¸</button>
                </form>
                {% endif %}
                <!-- Move down -->
                {% if not loop.last %}
                <form method="post" action="/dashboard/ai-providers/{{ p.id }}/move">
                    <input type="hidden" name="direction" value="down">
                    <button class="btn-sm btn-move" title="ØªØ­Ø±ÙŠÙƒ Ù„Ù„Ø£Ø³ÙÙ„">â¬‡ï¸</button>
                </form>
                {% endif %}
                <!-- Toggle -->
                <form method="post" action="/dashboard/ai-providers/{{ p.id }}/toggle">
                    <button class="btn-sm btn-toggle {% if not p.is_active %}off{% endif %}">
                        {% if p.is_active %}âœ… Ù…ÙØ¹Ù‘Ù„{% else %}â›” Ù…Ø¹Ø·Ù‘Ù„{% endif %}
                    </button>
                </form>
                <!-- Delete -->
                <form method="post" action="/dashboard/ai-providers/{{ p.id }}/delete">
                    <button class="btn-sm btn-delete" onclick="return confirm('Ø­Ø°Ù {{ p.name }}ØŸ')">ğŸ—‘ï¸</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Add form -->
    <div class="add-form-card">
        <h2 style="margin:0 0 1.25rem;font-size:1.1rem;">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø²ÙˆØ¯ Ø¬Ø¯ÙŠØ¯</h2>
        <form method="post" action="/dashboard/ai-providers/add">
            <div class="form-grid">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… (Ù„Ù„ØªØ¹Ø±ÙŠÙ ÙÙ‚Ø·)</label>
                    <input type="text" name="name" placeholder="Ù…Ø«Ø§Ù„: Gemini Key 1" required>
                </div>
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø²ÙˆØ¯</label>
                    <select name="provider_type" id="provider_type" onchange="onTypeChange()">
                        <option value="google_studio">ğŸ”µ Google AI Studio</option>
                        <option value="blackbox">ğŸŸ£ Blackbox.ai</option>
                        <option value="huggingface">ğŸŸ  HuggingFace</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ù…ÙØªØ§Ø­ API</label>
                    <input type="password" name="api_key" id="api_key_input" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ù€ API" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØ±ØªÙŠØ¨ (Ø£Ø±Ù‚Ø§Ù… Ø£ØµØºØ± = ÙŠÙØ¬Ø±ÙÙ‘Ø¨ Ø£ÙˆÙ„Ø§Ù‹)</label>
                    <input type="number" name="priority" value="10" min="1" max="999">
                    <span class="priority-hint">Ù…Ø«Ø§Ù„: 1 â†’ 2 â†’ 3 â†’ 10 (HuggingFace)</span>
                </div>
                <div class="form-group model-presets">
                    <label id="model_label">Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</label>
                    <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;align-items:center;">
                        <select id="model_preset" onchange="onPresetChange()" style="flex:1;">
                        </select>
                        <button type="button" id="btn_fetch_models" onclick="fetchModels()"
                            style="background:#6366f122;color:#a5b4fc;border:1px solid #6366f155;border-radius:8px;padding:0.5rem 0.85rem;cursor:pointer;font-family:inherit;font-size:0.82rem;white-space:nowrap;">
                            ğŸ” Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª
                        </button>
                    </div>
                    <input type="text" name="model" id="model" placeholder="Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠØ¯ÙˆÙŠØ§Ù‹" required>
                </div>
            </div>
            <button type="submit" class="btn-add">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙˆØ¯</button>
        </form>
    </div>
</div>
{% endblock %}