{% extends "base.html" %}
{% block title %}Vex â€” Ù…Ø²ÙˆØ¯Ùˆ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ{% endblock %}
{% block page_title %}ğŸ¤– Ù…Ø²ÙˆØ¯Ùˆ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ{% endblock %}

{% block head %}
<script>
    const MODEL_PRESETS = {
        google_studio: [
            { v: "gemini-2.0-flash", l: "Gemini 2.0 Flash       â€” Ù…Ø¬Ø§Ù†ÙŠ Â· Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹ âš¡" },
            { v: "gemini-2.0-flash-lite", l: "Gemini 2.0 Flash Lite  â€” Ù…Ø¬Ø§Ù†ÙŠ Â· Ø§Ù„Ø£Ø±Ø®Øµ ğŸ’š" },
            { v: "gemini-1.5-flash", l: "Gemini 1.5 Flash       â€” Ù…Ø¬Ø§Ù†ÙŠ Â· Ù…ÙˆØµÙ‰ Ø¨Ù‡ âœ…" },
            { v: "gemini-1.5-flash-8b", l: "Gemini 1.5 Flash-8B    â€” Ù…Ø¬Ø§Ù†ÙŠ Â· ØµØºÙŠØ± ÙˆØ³Ø±ÙŠØ¹" },
            { v: "gemini-1.5-pro", l: "Gemini 1.5 Pro         â€” Ù…Ø¬Ø§Ù†ÙŠ Â· 50 Ø·Ù„Ø¨/ÙŠÙˆÙ…" },
            { v: "gemini-2.0-pro", l: "Gemini 2.0 Pro         â€” Ù…Ø¯ÙÙˆØ¹ Â· Ø§Ù„Ø£Ù‚ÙˆÙ‰ ğŸ’" },
        ],
        blackbox: [
            { v: "deepseek-v3", l: "DeepSeek V3            â€” $0.07/M Â· Ø§Ù„Ø£Ø±Ø®Øµ â­" },
            { v: "deepseek-r1", l: "DeepSeek R1            â€” $0.14/M Â· ØªÙÙƒÙŠØ± Ø¹Ù…ÙŠÙ‚" },
            { v: "meta-llama/Llama-3.3-70b", l: "Llama 3.3 70B          â€” $0.20/M Â· Ù…ÙØªÙˆØ­ Ø§Ù„Ù…ØµØ¯Ø±" },
            { v: "claude-3-5-haiku-20241022", l: "Claude 3.5 Haiku       â€” $0.25/M Â· Ø³Ø±ÙŠØ¹" },
            { v: "gpt-4o-mini", l: "GPT-4o Mini            â€” $0.50/M Â· Ù…ØªÙˆØ§Ø²Ù†" },
            { v: "gpt-4o", l: "GPT-4o                 â€” $5/M  Â· ØºØ§Ù„ÙŠ ğŸ”´" },
        ],
        huggingface: [
            { v: "aubmindlab/bert-base-arabertv02", l: "AraBERT â€” Ø¹Ø±Ø¨ÙŠ Ù…ØªØ®ØµØµ âœ…" },
            { v: "CAMeL-Lab/bert-base-arabic-camelbert-mix-sentiment", l: "CAMeL Sentiment â€” Ù…Ø´Ø§Ø¹Ø± Ø¹Ø±Ø¨ÙŠ" },
            { v: "facebook/bart-large-mnli", l: "BART MNLI â€” ØªØµÙ†ÙŠÙ Ø¹Ø§Ù…" },
            { v: "joeddav/xlm-roberta-large-xnli", l: "XLM-RoBERTa â€” Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù„ØºØ§Øª" },
        ],
    };
    function onTypeChange() {
        const type = document.getElementById('provider_type').value;
        const sel = document.getElementById('model_preset');
        sel.innerHTML = '';
        (MODEL_PRESETS[type] || []).forEach(p => {
            const o = document.createElement('option');
            o.value = p.v; o.textContent = p.l;
            sel.appendChild(o);
        });
        document.getElementById('model').value = (MODEL_PRESETS[type] || [])[0]?.v || '';
    }
    function onPresetChange() {
        document.getElementById('model').value = document.getElementById('model_preset').value;
    }
    async function fetchModels() {
        const type = document.getElementById('provider_type').value;
        const key = document.getElementById('api_key_input').value.trim();
        if (!key) { alert('Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ù€ API Ø£ÙˆÙ„Ø§Ù‹'); return; }
        const btn = document.getElementById('btn_fetch');
        btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...'; btn.disabled = true;
        try {
            const r = await fetch(`/dashboard/ai-providers/fetch-models?provider_type=${encodeURIComponent(type)}&api_key=${encodeURIComponent(key)}`);
            const d = await r.json();
            const sel = document.getElementById('model_preset');
            sel.innerHTML = '';
            (d.models || []).forEach(m => {
                const o = document.createElement('option'); o.value = m; o.textContent = m; sel.appendChild(o);
            });
            if (d.models?.length) { document.getElementById('model').value = d.models[0]; alert(`âœ… Ø¬ÙÙ„Ø¨ ${d.models.length} Ù…ÙˆØ¯ÙŠÙ„`); }
            else alert('Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ Ù…ÙˆØ¯ÙŠÙ„Ø§Øª: ' + (d.error || ''));
        } finally { btn.textContent = 'ğŸ” Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª'; btn.disabled = false; }
    }
    window.onload = onTypeChange;
</script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Ù…Ø²ÙˆØ¯Ùˆ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h1>
    <p class="page-subtitle">ÙŠÙØ¬Ø±ÙÙ‘Ø¨ Ø§Ù„Ù…Ø²ÙˆØ¯ÙˆÙ† Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ â€” Ø¥Ø°Ø§ ÙØ´Ù„ Ø£Ø­Ø¯Ù‡Ù… Ø§Ù†ØªÙ‚Ù„ Ù„Ù„ØªØ§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
</div>

<!-- Provider list -->
{% if providers %}
<div class="provider-list">
    {% for p in providers %}
    {% set icons = {"google_studio": "ğŸ”µ", "blackbox": "ğŸŸ£", "huggingface": "ğŸŸ "} %}
    <div class="provider-card {% if not p.is_active %}inactive{% endif %}">
        <div class="provider-order">{{ loop.index }}</div>
        <div class="provider-icon">{{ icons.get(p.provider_type, "ğŸ¤–") }}</div>
        <div class="provider-info">
            <div class="provider-name">{{ p.name }}</div>
            <div class="provider-meta">{{ p.provider_type }} Â· {{ p.model }} Â· Ù…ÙØªØ§Ø­: {{ p.api_key[:6] }}â€¢â€¢â€¢â€¢</div>
        </div>
        <div class="provider-actions">
            {% if not loop.first %}
            <form method="post" action="/dashboard/ai-providers/{{ p.id }}/move">
                <input type="hidden" name="direction" value="up">
                <button type="submit" class="btn btn-ghost btn-sm" title="Ø£Ø¹Ù„Ù‰">â¬†ï¸</button>
            </form>
            {% endif %}
            {% if not loop.last %}
            <form method="post" action="/dashboard/ai-providers/{{ p.id }}/move">
                <input type="hidden" name="direction" value="down">
                <button type="submit" class="btn btn-ghost btn-sm" title="Ø£Ø³ÙÙ„">â¬‡ï¸</button>
            </form>
            {% endif %}
            <form method="post" action="/dashboard/ai-providers/{{ p.id }}/toggle">
                <button type="submit" class="btn btn-sm {% if p.is_active %}btn-success{% else %}btn-danger{% endif %}">
                    {% if p.is_active %}âœ… Ù…ÙØ¹Ù‘Ù„{% else %}â›” Ù…Ø¹Ø·Ù‘Ù„{% endif %}
                </button>
            </form>
            <form method="post" action="/dashboard/ai-providers/{{ p.id }}/delete"
                onsubmit="return confirm('Ø­Ø°Ù {{ p.name }}ØŸ')">
                <button type="submit" class="btn btn-danger btn-sm">ğŸ—‘ï¸</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card" style="margin-bottom:1.5rem;">
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ¤–</div>
        <div class="empty-state-text">Ù„Ù… ØªÙØ¶Ù Ø£ÙŠ Ù…Ø²ÙˆØ¯ÙŠÙ† â€” Ø£Ø¶Ù Ø£ÙˆÙ„ Ù…Ø²ÙˆØ¯ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¯Ù†Ø§Ù‡</div>
    </div>
</div>
{% endif %}

<!-- Add form -->
<div class="card">
    <h2 style="font-size:1rem;font-weight:700;color:var(--primary);margin-bottom:1.25rem;">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø²ÙˆØ¯ Ø¬Ø¯ÙŠØ¯</h2>
    <form method="post" action="/dashboard/ai-providers/add">
        <div class="form-grid" style="margin-bottom:1rem;">
            <div class="form-group">
                <label class="form-label">Ø§Ù„Ø§Ø³Ù… (Ù„Ù„ØªØ¹Ø±ÙŠÙ ÙÙ‚Ø·)</label>
                <input class="input" type="text" name="name" placeholder="Ù…Ø«Ø§Ù„: Gemini Key 1" required>
            </div>
            <div class="form-group">
                <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø²ÙˆØ¯</label>
                <select class="select-field" name="provider_type" id="provider_type" onchange="onTypeChange()">
                    <option value="google_studio">ğŸ”µ Google AI Studio</option>
                    <option value="blackbox">ğŸŸ£ Blackbox.ai</option>
                    <option value="huggingface">ğŸŸ  HuggingFace</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Ù…ÙØªØ§Ø­ API</label>
                <input class="input" type="password" name="api_key" id="api_key_input" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ù€ API"
                    required>
            </div>
            <div class="form-group">
                <label class="form-label">Ø§Ù„ØªØ±ØªÙŠØ¨ (Ø£ØµØºØ± = ÙŠÙØ¬Ø±ÙÙ‘Ø¨ Ø£ÙˆÙ„Ø§Ù‹)</label>
                <input class="input" type="number" name="priority" value="10" min="1" max="999">
            </div>
            <div class="form-group" style="grid-column:1/-1;">
                <label class="form-label">Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</label>
                <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;align-items:center;">
                    <select class="select-field" id="model_preset" onchange="onPresetChange()" style="flex:1;"></select>
                    <button type="button" id="btn_fetch" onclick="fetchModels()" class="btn btn-ghost btn-sm">ğŸ” Ø¬Ù„Ø¨
                        Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª</button>
                </div>
                <input class="input" type="text" name="model" id="model" placeholder="Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠØ¯ÙˆÙŠØ§Ù‹"
                    required>
            </div>
        </div>
        <button type="submit" class="btn btn-primary btn-full btn-lg">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙˆØ¯</button>
    </form>
</div>
{% endblock %}